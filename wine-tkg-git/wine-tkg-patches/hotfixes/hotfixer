#!/bin/bash

if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor fd7992972b252ed262d33ef604e9e1235d2108c5 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "HALP! We got some hotfixes for your current tree!"
    read -rp "Do you want to apply them all with no further prompt?"$'\n> Y/n : ' _hotfixansw;
    if [ "$_hotfixansw" != "n" ] && [ "$_hotfixansw" != "N" ]; then
      _hotfixes_no_confirm="true"
    fi
  fi
fi

# Wine Destroyer - fd7992972b252ed262d33ef604e9e1235d2108c5
# https://bugs.winehq.org/show_bug.cgi?id=48971
# https://bugs.winehq.org/show_bug.cgi?id=49007
# https://bugs.winehq.org/show_bug.cgi?id=49025
# https://bugs.winehq.org/show_bug.cgi?id=49098
# https://bugs.winehq.org/show_bug.cgi?id=49123
# https://bugs.winehq.org/show_bug.cgi?id=49041
if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor fd7992972b252ed262d33ef604e9e1235d2108c5 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "Hotfix: An upstream patchset (starting with fd79929) breaks a large amount of games in various ways (ex: WoW, Overwatch, Star Citizen, Path of Exile etc.). As a temporary fix, this patch reverts it on current HEAD."
    read -rp "Apply it?"$'\n> N/y : ' _hotfixansw_fd79;
  fi
  if [ "$_hotfixansw_fd79" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor b7b1ad09629a6678383a5ae791a9507c9eb87be3 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-6)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor d2b70aa57a77103107a2e620999181c518d14bda HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-5)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 68e675d73db4fb90fff84c0e1f6de3b492061b5f HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-4)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 6f4272ce3e74f2d30f45bf0d407cdc9264b813a9 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-3)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 0a72ec1dacb59c72980c3133fddf316377349048 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-2)
    else
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5)
    fi
  fi
fi

# Esync/Fsync killer - mainline reverts
if ( [ "$_staging_esync" = "true" ] || [ "$_use_esync" = "true" ] || [ "$_use_fsync" = "true" ] || [ "$_large_address_aware" = "true" ] ) || ( [ "$_use_staging" = "false" ] && [ "$_use_esync" = "false" ] ) && ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 01150d7f8d27ad5efdb824da938c4a9fa562a036 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ] && [ "$_hotfixansw_fd79" != "y" ]; then
    warning "Hotfix: Upstream commits 01150d7 to e854ea3 broke esync patchset (which has been disabled in staging as a result) leading to fsync getting broken as well."
    read -rp "Wanna bring back esync/fsync ?"$'\n> N/y : ' _hotfixansw;
  fi
  if [ "$_hotfixansw" = "y" ] || [ "$_hotfixansw_fd79" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    _hotfix_mainlinereverts+=(7e9ccbe68fe5215df9bd8e424195e1abf56f7286 f6bfb4ce00d27c4bc11615a5426065749e72b70a 888d66a2376f0da076ec312ef5ca2d93fee0e2f9 e9e5c95058df1f409debeb6b05aa222b476d79f6 c4c3b06e83ce8f7f18e77a101656ba983fb0d0e3 a20b997b3430bd7dc94ffd587cd299efa467420e 98eab245d3c3377af0c3da6880bb8ede80cb0925 c3e2013b615dd449113fe8fce0700319aa082020 07248fc5002fb109de8fc8e51e9d05329e0cd8cc 06fa3d32a73d59c7fec59a8682e3750150f84554 9ed951266244ad75454cfdb63ee0e872ca9ac43b e0fca9451146908402a8fbc770ff189aba636213 573be7e6023e73d736c341bdca1ee49594f56ee4 412555e0cdcd16439db56f6bd6ea56cedcda0883 d4c2b61c48cdd35275684e75427d2cf0d8d928de b86dc3926bfe5cd92400aa96c89b0255eba1d447 ee5c842e5303c70e88a1c68390c46db1f1689f19 a4ce2f652d76d033a79434416ff585cd15356a87 84d25135b3b2f9a30619f741d166fa1daa8298e5 df513b95ec24d279a10fbe358973662ce2c9c385 d8d6a6b2e639d2e29e166a3faf988b81388ae191 ff19f21913c508f5827df0e7e4c3a351c36711a0 552bc8aa4703b674747df36c591038da17c0c858 509ad75adbca85d606a3bd8bba727abf0751cebc 246dedaa091308f140a3cac41845f5e978492e37 4d70266274c1102c385dd00303d312d94453d19b 2333099c52566c6cf3d3f981588a26d4ff408155 0c14b1a962573ee125940f2008c646befe597226 683583faf2f4b00874f702429393b127aca8eef4 20c91c5e803090bd40fe3045a0d9fea0a68913e4 7f28a1c521341399da1f3559358f2abf876d34be 95e2d05e5d6b92a2f6b28e00f36064b7bf6b249a e561ce4b9259071f79d219dddf62f05cdd8dd07b 8e5d3042786917c04d3065755d81e7f8a751e529 245efd04e1456a71a6962acbb8ebc279481e9ffa 33c750f50ff8b6f1eae63140e8287c49a5130a60 39e7f25e0918d23e5b9ef5fc5049948b6f56525e ca3ca7b046ae94a152b1367ca982774345887e55 cdfc45859c299aa629482ee06614c9819346b444 f1276b25ae72e81cf044134bae92db6ef73be3a1 65edacf93484faf1dc3d11e555081d69556ccbc3 8b87d6b81408e5d6fe34f9e9fda1df2f4f2e5cd0 efd59e378c2ba8cae98fa664ae98521027e96b81 39915c9bc42f17619b1d2c46e6b3aea485c471a0 a18444984171ee86503d1250094965fb50a198ee 4ffe39573b537d638e4b39c9b5990c6566d62b09 cd0c5988020acc92ff98260e3304967bf31e4e87 f1d40d4824b568389cbc328cebb5734430b52e44 35b063a404457fdf956d1913738a3c8a66266cb4 be0eb9c92eb7a4fcd9d0d48568c8ed5e8326ef0b 9fe61171e515e7c77720675ecbe69731219b549c c96ef78b6d6d9184d8ec4cd18924a3049d388583 7c32b2dd9368137eca3cf0202360bbe0db62efbf ac90898f72b02bbc226a95deb40555c1fb8ac3a3 87fa906a84621295a76035d73dd6305c9cd2ea4a c0319e0eabbad87a3e153c23f2461c881153b984 b925dd78b813decf386139a15aa7bc6863ee7ae5 3e9f8c87e5a2acaa80f8bbb1d50fa82147942143 704975f58d7947721f530d202022721c16df466a 04f41e87a369828a698f62c32cabad34ed34a3e7 01150d7f8d27ad5efdb824da938c4a9fa562a036 1a743c9af39d0224b65ae504ae7e24d9fad56c2b 8a63b688ac49f19c259066fd100407edf3747f95 e6e2f2325a0a4eb14f10dd6df319b068761e9600 e854ea34cc481658ec61f4603d0438e075608c98)
    #_hotfix_stagingreverts=()

    # Apply fixed d8d6a6b2e639d2e29e166a3faf988b81388ae191 - server: Partially implement JobObjectBasicAccountingInformation.
    if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor a302ab44acaf72ecc9b0307c82a7d11f759e6a72 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/d8d6a6b2e639d2e29e166a3faf988b81388ae191)
    fi

    # staging unbreak - #1
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 03f5adcafbf5136a92ad7474265e4e81bc69678c HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-21)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 984d40224092f734d94e3d52e33230444798de96 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-20)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 32fcc0d75b74642e0f5675e9e3ffcf081ec3f9b2 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-19)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor b6595d9e28a60b48030a3b74c31afd73b1fe4065 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-18)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor eb4f9db59c29b92131b9d0de35200b9abf1d394a HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-17)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 11f545447b76eeab1ceadbdf9a58ee3d07d281fb HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-16)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 7934e14fc04a4dbcc19f9a3ada72cf6822cc4098 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-15)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 5306e1df11e772fe8125fcd5857e52cf1f83430b HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-14)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 938c0aa15547f151622dfdeb1f66507624248cf4 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-13)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor cb2a6551bc686820bda7efb21da45663128d0b2c HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-12)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 9a4c8c5631101f8571dbdce726ae864060e446c9 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-11)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 044cb930662d61f401a5d1bdd7b8e75d59cea5ea HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-10)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor f1917e904a666bf492b8109f29869ff14f8c2623 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-9)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor f12808c094ef06ba7151d35e6c6e70ae965ac2c3 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-8)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 8a2765d1250572378f4c43f9f4e19e7295ac9fb4 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-7)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 7b78338b078a7a55c5851a91064ef70836f4c996 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-6)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor a4d98c48f982b52375f0ccefc217984aab936033 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-5)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-4)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-3)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor f132e60b9db336495acc50f2a31a6aeca8d89de5 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-2)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 06877e55b1100cc49d3726e9a70f31c4dfbe66f8 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8)
    fi
    # staging unbreak - #2
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c-3)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c-2)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 934a09585a15e8491e422b43624ffe632b02bd3c HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c)
    fi

    # Fixups for staging's ntdll-ForceBottomUpAlloc
    if [ "$_use_staging" = "true" ] && [[ ! ${_staging_userargs[*]} =~ "ntdll-ForceBottomUpAlloc" ]] && ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 044cb930662d61f401a5d1bdd7b8e75d59cea5ea HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/ntdll-ForceBottomUpAlloc-044cb93)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _staging_args+=(-W ntdll-ForceBottomUpAlloc) # Disable the patchset from 676f261e to 044cb930 due to breakage
    fi
  else
    _broken_staging_44d1a45_localreverts="true"
    _use_esync="false"
    _use_fsync="false"
    _proton_rawinput="false"
    _large_address_aware="false"
    _protonify="false"
    _msvcrt_nativebuiltin="false"
    warning "You have refused hotfixes. Due to regressions and refactoring upstream, the following features have been forcefully disabled: Esync, Fsync, Proton-rawinput, LAA, Protonify, native/builtin msvcrt. If you want any of those features back, you need to accept all currently available hotfixes."
    read -rp "Press enter to continue anyway..."
  fi
elif [ "$_use_esync" != "true" ] || ( [ "$_use_staging" = "true" ] && [ "$_staging_esync" != "true" ] ) && ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 01150d7f8d27ad5efdb824da938c4a9fa562a036 HEAD ); then
  _broken_staging_44d1a45_localreverts="true"
fi

# lolpatchisdead
if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ) && [ "$_lol920_fix" = "true" ]; then
  warning "The _lol920_fix option breaks on your current tree and has been disabled. Please use an older Wine version until a solution is found."
  _lol920_fix="false"
fi

# WINEDEBUG crash - legacy
if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor ca13f489e18fb1f7944e3bdcfdfc4a810bf80994 HEAD ) && ( cd "${srcdir}"/"${_stgsrcdir}" && ! git merge-base --is-ancestor a1bda115af8ad3484b7c17eac7da74e4906fa9e4 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "Hotfix: Upstream commits cd215bb to ca13f48 are interacting badly with WINEDEBUG env var and break staging."
    read -rp "Are you okay to revert them ?"$'\n> N/y : ' _hotfixansw;
  fi
  if [ "$_hotfixansw" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    _hotfix_mainlinereverts=(cd215bb49bc240cdce5415c80264f8daa557636a 8ca9e0b1abba7640e288df7b55b60903bc52fc9d 6a1667fab428764eeaba38ac9b5cb1813c5cffda 9b12068c6c8ba656e8ca768227b1a970877d4730 cc5953048e570155deb791b9e9e738a0508c2032 0936606c383744daa8be046db72e8e888522ce21 ca13f489e18fb1f7944e3bdcfdfc4a810bf80994)
    _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/a1bda115/acd209d6039f2492bdc8aca3d15bb1b268b04f1a)
    # Staging conflict
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 4501d49149e37b37edd61f8a1694930db7418a61 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/a1bda115/4501d49149e37b37edd61f8a1694930db7418a61)
    fi
  fi
fi

hotfixer() {
  for _f in "${_hotfixes[@]}"; do
    if [ -e "${_f}.${_userpatch_ext}revert" ]; then
      msg2 "## Applying reverting hotfix for ${_userpatch_target}: ${_f##*/}.${_userpatch_ext}revert"
      echo -e "\nApplying reverting hotfix ${_f##*/}.${_userpatch_ext}revert" >> "$_where"/prepare.log
      patch -Np1 -R < "${_f}.${_userpatch_ext}revert" >> "$_where"/prepare.log || (error "Patch application has failed. The error was logged to $_where/prepare.log for your convenience." && exit 1)
      echo "Applied reverting hotfix ${_f##*/}.${_userpatch_ext}revert" >> "$_where"/last_build_config.log
    fi
  done
  for _f in "${_hotfixes[@]}"; do
    if [ -e "${_f}.${_userpatch_ext}patch" ]; then
      msg2 "## Applying hotfix for ${_userpatch_target}: ${_f##*/}.${_userpatch_ext}patch"
      echo -e "\nApplying hotfix ${_f##*/}.${_userpatch_ext}patch" >> "$_where"/prepare.log
      patch -Np1 < "${_f}.${_userpatch_ext}patch" >> "$_where"/prepare.log || (error "Patch application has failed. The error was logged to $_where/prepare.log for your convenience." && exit 1)
      echo "Applied hotfix ${_f##*/}.${_userpatch_ext}patch" >> "$_where"/last_build_config.log
    fi
  done
}

#!/bin/bash

if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor fd7992972b252ed262d33ef604e9e1235d2108c5 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "HALP! We got some hotfixes for your current tree!"
    read -rp "Do you want to apply them all with no further prompt?"$'\n> Y/n : ' _hotfixansw;
    if [ "$_hotfixansw" != "n" ] && [ "$_hotfixansw" != "N" ]; then
      _hotfixes_no_confirm="true"
    fi
  fi
fi

# Wine Destroyer - fd7992972b252ed262d33ef604e9e1235d2108c5
# https://bugs.winehq.org/show_bug.cgi?id=48971
# https://bugs.winehq.org/show_bug.cgi?id=49007
# https://bugs.winehq.org/show_bug.cgi?id=49025
# https://bugs.winehq.org/show_bug.cgi?id=49098
# https://bugs.winehq.org/show_bug.cgi?id=49123
# https://bugs.winehq.org/show_bug.cgi?id=49041
if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor fd7992972b252ed262d33ef604e9e1235d2108c5 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "Hotfix: An upstream patchset (starting with fd79929) breaks a large amount of games in various ways (ex: WoW, Overwatch, Star Citizen, Path of Exile etc.). As a temporary fix, this patch reverts it on current HEAD."
    read -rp "Apply it?"$'\n> N/y : ' _hotfixansw;
  fi
  if [ "$_hotfixansw" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor b7b1ad09629a6678383a5ae791a9507c9eb87be3 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-6)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor d2b70aa57a77103107a2e620999181c518d14bda HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-5)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 68e675d73db4fb90fff84c0e1f6de3b492061b5f HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-4)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 6f4272ce3e74f2d30f45bf0d407cdc9264b813a9 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-3)
    elif ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 0a72ec1dacb59c72980c3133fddf316377349048 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5-2)
    else
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/fd799297/fd7992972b252ed262d33ef604e9e1235d2108c5)
    fi
  fi
fi

# Esync/Fsync killer - mainline reverts
if ( [ "$_use_esync" = "true" ] || [ "$_use_fsync" = "true" ] ) && ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 01150d7f8d27ad5efdb824da938c4a9fa562a036 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "Hotfix: Upstream commits 01150d7 to e854ea3 broke esync patchset (which has been disabled in staging as a result) leading to fsync getting broken as well."
    read -rp "Wanna bring back esync/fsync ?"$'\n> N/y : ' _hotfixansw;
  fi
  if [ "$_hotfixansw" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    _hotfix_mainlinereverts=(cdfc45859c299aa629482ee06614c9819346b444 f1276b25ae72e81cf044134bae92db6ef73be3a1 65edacf93484faf1dc3d11e555081d69556ccbc3 8b87d6b81408e5d6fe34f9e9fda1df2f4f2e5cd0 efd59e378c2ba8cae98fa664ae98521027e96b81 39915c9bc42f17619b1d2c46e6b3aea485c471a0 a18444984171ee86503d1250094965fb50a198ee 4ffe39573b537d638e4b39c9b5990c6566d62b09 cd0c5988020acc92ff98260e3304967bf31e4e87 f1d40d4824b568389cbc328cebb5734430b52e44 35b063a404457fdf956d1913738a3c8a66266cb4 be0eb9c92eb7a4fcd9d0d48568c8ed5e8326ef0b 9fe61171e515e7c77720675ecbe69731219b549c c96ef78b6d6d9184d8ec4cd18924a3049d388583 7c32b2dd9368137eca3cf0202360bbe0db62efbf ac90898f72b02bbc226a95deb40555c1fb8ac3a3 87fa906a84621295a76035d73dd6305c9cd2ea4a c0319e0eabbad87a3e153c23f2461c881153b984 b925dd78b813decf386139a15aa7bc6863ee7ae5 3e9f8c87e5a2acaa80f8bbb1d50fa82147942143 704975f58d7947721f530d202022721c16df466a 04f41e87a369828a698f62c32cabad34ed34a3e7 01150d7f8d27ad5efdb824da938c4a9fa562a036 1a743c9af39d0224b65ae504ae7e24d9fad56c2b 8a63b688ac49f19c259066fd100407edf3747f95 e6e2f2325a0a4eb14f10dd6df319b068761e9600 e854ea34cc481658ec61f4603d0438e075608c98)
    #_hotfix_stagingreverts=()
    # Esync/Fsync killer - staging unbreak - #1
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 8a2765d1250572378f4c43f9f4e19e7295ac9fb4 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-7)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 7b78338b078a7a55c5851a91064ef70836f4c996 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-6)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor a4d98c48f982b52375f0ccefc217984aab936033 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-5)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-4)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-3)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor f132e60b9db336495acc50f2a31a6aeca8d89de5 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8-2)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 06877e55b1100cc49d3726e9a70f31c4dfbe66f8 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/06877e55b1100cc49d3726e9a70f31c4dfbe66f8)
    fi
    #2
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c-3)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c-2)
    elif ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 934a09585a15e8491e422b43624ffe632b02bd3c HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/01150d7f/934a09585a15e8491e422b43624ffe632b02bd3c)
    fi
    # Fixup
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 676f261e5e9959e8fb9fe6266ffd2a29bcda2c0d HEAD ); then
      _staging_args+=(-W ntdll-ForceBottomUpAlloc)
    fi
  else
    _broken_staging_44d1a45_localreverts="true"
    _use_esync="false"
    _use_fsync="false"
    _proton_rawinput="false"
    _large_address_aware="false"
    _protonify="false"
  fi
elif ( [ "$_use_esync" != "true" ] || [ "$_use_fsync" != "true" ] ) && ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor 01150d7f8d27ad5efdb824da938c4a9fa562a036 HEAD ); then
  _broken_staging_44d1a45_localreverts="true"
fi

# lolpatchisdead
if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor c81093882b2b9ce4a5830437cecdc58b8807d29b HEAD ) && [ "$_lol920_fix" = "true" ]; then
  warning "The _lol920_fix option breaks on your current tree and has been disabled. Please use an older Wine version until a solution is found."
  _lol920_fix="false"
fi

# WINEDEBUG crash - legacy
if ( cd "${srcdir}"/"${_winesrcdir}" && git merge-base --is-ancestor ca13f489e18fb1f7944e3bdcfdfc4a810bf80994 HEAD ) && ( cd "${srcdir}"/"${_stgsrcdir}" && ! git merge-base --is-ancestor a1bda115af8ad3484b7c17eac7da74e4906fa9e4 HEAD ); then
  if [ "$_hotfixes_no_confirm" != "true" ]; then
    warning "Hotfix: Upstream commits cd215bb to ca13f48 are interacting badly with WINEDEBUG env var and break staging."
    read -rp "Are you okay to revert them ?"$'\n> N/y : ' _hotfixansw;
  fi
  if [ "$_hotfixansw" = "y" ] || [ "$_hotfixes_no_confirm" = "true" ]; then
    _hotfix_mainlinereverts=(cd215bb49bc240cdce5415c80264f8daa557636a 8ca9e0b1abba7640e288df7b55b60903bc52fc9d 6a1667fab428764eeaba38ac9b5cb1813c5cffda 9b12068c6c8ba656e8ca768227b1a970877d4730 cc5953048e570155deb791b9e9e738a0508c2032 0936606c383744daa8be046db72e8e888522ce21 ca13f489e18fb1f7944e3bdcfdfc4a810bf80994)
    _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/a1bda115/acd209d6039f2492bdc8aca3d15bb1b268b04f1a)
    # Staging conflict
    if ( cd "${srcdir}"/"${_stgsrcdir}" && git merge-base --is-ancestor 4501d49149e37b37edd61f8a1694930db7418a61 HEAD ); then
      _hotfixes+=("$_where"/wine-tkg-patches/hotfixes/a1bda115/4501d49149e37b37edd61f8a1694930db7418a61)
    fi
  fi
fi

hotfixer() {
  for _f in "${_hotfixes[@]}"; do
    if [ -e "${_f}.${_userpatch_ext}revert" ]; then
      msg2 "## Applying reverting hotfix for ${_userpatch_target}: ${_f##*/}.${_userpatch_ext}revert"
      echo -e "\nApplying reverting hotfix ${_f##*/}.${_userpatch_ext}revert" >> "$_where"/prepare.log
      patch -Np1 -R < "${_f}.${_userpatch_ext}revert" >> "$_where"/prepare.log || (error "Patch application has failed. The error was logged to $_where/prepare.log for your convenience." && exit 1)
      echo "Applied reverting hotfix ${_f##*/}.${_userpatch_ext}revert" >> "$_where"/last_build_config.log
    fi
  done
  for _f in "${_hotfixes[@]}"; do
    if [ -e "${_f}.${_userpatch_ext}patch" ]; then
      msg2 "## Applying hotfix for ${_userpatch_target}: ${_f##*/}.${_userpatch_ext}patch"
      echo -e "\nApplying hotfix ${_f##*/}.${_userpatch_ext}patch" >> "$_where"/prepare.log
      patch -Np1 < "${_f}.${_userpatch_ext}patch" >> "$_where"/prepare.log || (error "Patch application has failed. The error was logged to $_where/prepare.log for your convenience." && exit 1)
      echo "Applied hotfix ${_f##*/}.${_userpatch_ext}patch" >> "$_where"/last_build_config.log
    fi
  done
}
